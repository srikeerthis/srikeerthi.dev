---
const endpoint = "/.netlify/functions/chat";
---

<div id="chat-widget" class="fixed bottom-4 right-4 z-50">
  <button
    id="chat-toggle"
    class="flex items-center gap-2 px-4 py-2 rounded-full shadow-lg bg-black text-white dark:bg-white dark:text-black text-sm"
    type="button"
  >
    <span>Ask about me</span>
  </button>

  <div
    id="chat-panel"
    class="mt-3 w-80 sm:w-96 border border-gray-300 dark:border-gray-700 rounded-lg p-4 bg-white/90 dark:bg-black/80 backdrop-blur-md shadow-xl hidden"
  >
    <div class="flex items-center justify-between mb-2">
      <h2 class="font-semibold text-black dark:text-white text-sm">
        Ask the RAG chatbot about Srikeerthi
      </h2>
      <button
        id="chat-close"
        type="button"
        class="text-xs text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-100"
      >
        âœ•
      </button>
    </div>
    <div
      id="chat-messages"
      class="space-y-2 max-h-64 overflow-y-auto text-sm mb-3"
    >
    </div>
    <form id="chat-form" class="flex gap-2">
      <input
        id="chat-input"
        type="text"
        class="flex-1 border border-gray-300 dark:border-gray-700 rounded px-2 py-1 bg-transparent text-black dark:text-white text-sm"
        placeholder="Ask about my background, projects, skills..."
      />
      <button
        type="submit"
        class="px-3 py-1 rounded bg-black dark:bg-white text-white dark:text-black text-xs"
      >
        Ask
      </button>
    </form>
  </div>
</div>

<script is:inline>
  (function () {
    const endpoint = "/.netlify/functions/chat";
    const toggle = document.getElementById("chat-toggle");
    const panel = document.getElementById("chat-panel");
    const closeBtn = document.getElementById("chat-close");
    const form = document.getElementById("chat-form");
    const input = document.getElementById("chat-input");
    const messagesEl = document.getElementById("chat-messages");

    if (!toggle || !panel || !form || !input || !messagesEl) return;

    let history = [];
    const STORAGE_KEY = "portfolio-chat-history";

    const saved = sessionStorage.getItem(STORAGE_KEY);
    if (saved) {
      try {
        history = JSON.parse(saved);
        history.forEach((m) => addMessage(m.role, m.text));
      } catch {}
    }

    function openPanel() {
      panel.classList.remove("hidden");
      toggle.classList.add("hidden");
    }

    function closePanel() {
      panel.classList.add("hidden");
      toggle.classList.remove("hidden");
    }

    function addMessage(role, text) {
      const div = document.createElement("div");
      div.className =
        role === "user"
          ? "text-right text-blue-600 dark:text-blue-300"
          : "text-left text-gray-800 dark:text-gray-100";
      div.textContent = text;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    toggle.addEventListener("click", () => {
      if (panel.classList.contains("hidden")) {
        openPanel();
        input.focus();
      } else {
        closePanel();
      }
    });

    if (closeBtn) {
      closeBtn.addEventListener("click", () => {
        closePanel();
      });
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const question = input.value.trim();
      if (!question) return;
      openPanel();

      history.push({ role: "user", text: question });
      addMessage("user", question);
      input.value = "";
      addMessage("assistant", "Thinking...");

      try {
        const res = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question, history: history.slice(-10) }),
        });

        const data = await res.json();
        messagesEl.removeChild(messagesEl.lastChild); // remove "Thinking..."
        const answer =
          data.answer || "Sorry, I dont have much information to answer.";
        history.push({ role: "assistant", text: answer });
        sessionStorage.setItem(STORAGE_KEY, JSON.stringify(history));
        addMessage("assistant", answer);
      } catch (err) {
        messagesEl.removeChild(messagesEl.lastChild);
        addMessage("assistant", "Error contacting the chatbot.");
      }
    });
  })();
</script>
